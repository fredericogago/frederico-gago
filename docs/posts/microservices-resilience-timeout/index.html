<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>How to Handle Microservice Failures: The Ambiguous Timeout Dilemma | Frederico Gago ‚Äì Tech Blog</title>
<meta name="keywords" content="Microservices, Resilience, Python, FastAPI, Clean Architecture, Distributed Systems">
<meta name="description" content="When a service call times out and you don‚Äôt know what happened ‚Äî how do you stay correct, consistent, and auditable? Let&#39;s explore resilience, idempotency, and compensation patterns with Python examples.">
<meta name="author" content="Frederico Gago">
<link rel="canonical" href="https://fredericogago.github.io/frederico-gago/posts/microservices-resilience-timeout/">
<link crossorigin="anonymous" href="https://fredericogago.github.io/frederico-gago/assets/css/stylesheet.2211ca3164be7830024f6aad2b3a2e520843a64f8f048445c3401c1249aa051d.css" integrity="sha256-IhHKMWS&#43;eDACT2qtKzouUghDpk&#43;PBIRFw0AcEkmqBR0=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://fredericogago.github.io/frederico-gago/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://fredericogago.github.io/frederico-gago/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://fredericogago.github.io/frederico-gago/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://fredericogago.github.io/frederico-gago/apple-touch-icon.png">
<link rel="mask-icon" href="https://fredericogago.github.io/frederico-gago/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://fredericogago.github.io/frederico-gago/posts/microservices-resilience-timeout/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://fredericogago.github.io/frederico-gago/posts/microservices-resilience-timeout/">
  <meta property="og:site_name" content="Frederico Gago ‚Äì Tech Blog">
  <meta property="og:title" content="How to Handle Microservice Failures: The Ambiguous Timeout Dilemma">
  <meta property="og:description" content="When a service call times out and you don‚Äôt know what happened ‚Äî how do you stay correct, consistent, and auditable? Let&#39;s explore resilience, idempotency, and compensation patterns with Python examples.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-10-06T18:55:59+01:00">
    <meta property="article:modified_time" content="2025-10-06T18:55:59+01:00">
    <meta property="article:tag" content="Microservices">
    <meta property="article:tag" content="Resilience">
    <meta property="article:tag" content="Python">
    <meta property="article:tag" content="FastAPI">
    <meta property="article:tag" content="Clean Architecture">
    <meta property="article:tag" content="Distributed Systems">
    <meta property="og:image" content="https://fredericogago.github.io/frederico-gago/images/cover/microservices-resilience-diagram.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://fredericogago.github.io/frederico-gago/images/cover/microservices-resilience-diagram.png">
<meta name="twitter:title" content="How to Handle Microservice Failures: The Ambiguous Timeout Dilemma">
<meta name="twitter:description" content="When a service call times out and you don‚Äôt know what happened ‚Äî how do you stay correct, consistent, and auditable? Let&#39;s explore resilience, idempotency, and compensation patterns with Python examples.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blog",
      "item": "https://fredericogago.github.io/frederico-gago/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "How to Handle Microservice Failures: The Ambiguous Timeout Dilemma",
      "item": "https://fredericogago.github.io/frederico-gago/posts/microservices-resilience-timeout/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "How to Handle Microservice Failures: The Ambiguous Timeout Dilemma",
  "name": "How to Handle Microservice Failures: The Ambiguous Timeout Dilemma",
  "description": "When a service call times out and you don‚Äôt know what happened ‚Äî how do you stay correct, consistent, and auditable? Let's explore resilience, idempotency, and compensation patterns with Python examples.",
  "keywords": [
    "Microservices", "Resilience", "Python", "FastAPI", "Clean Architecture", "Distributed Systems"
  ],
  "articleBody": "üß© The Classic Problem: When a Service Doesn‚Äôt Respond Imagine the following flow in a service-oriented system:\nClient ‚Üí the-api ‚Üí the-upstream ‚Üí Database 1Ô∏è‚É£ The client calls the-api/v1/test\n2Ô∏è‚É£ the-api calls the-upstream\n3Ô∏è‚É£ the-upstream writes data into its own database\n4Ô∏è‚É£ It replies OK to the-api\n5Ô∏è‚É£ the-api stores the result in its database and replies OK to the client\nEverything works fine ‚Äî until step 4 (D) fails because of a network partition or timeout.\nNow, the-api doesn‚Äôt know if the upstream actually wrote the data or not.\nYou can‚Äôt safely commit your local write ‚Äî and you can‚Äôt confidently reply to the client.\nThis is the ambiguous timeout problem, one of the hardest challenges in distributed systems.\nüéØ The Goal We need to ensure that:\nNo operation executes twice (idempotency) No data is lost (durability) Every step is auditable The system remains useful even under partial failure (resilience) üèóÔ∏è The Design Philosophy The key is simple:\nüëâ First record the intent,\nüëâ Then attempt execution,\nand if anything fails, have a way to reconcile later.\n1Ô∏è‚É£ Operation ID and Idempotency Each operation must have a unique identifier ‚Äî created in the-api and passed along all downstream calls.\nimport uuid from fastapi import FastAPI, Header, HTTPException app = FastAPI() @app.post(\"/v1/test\") async def test_endpoint(idempotency_key: str | None = Header(None)): operation_id = idempotency_key or str(uuid.uuid7()) # Store operation as PENDING print(f\"New operation: {operation_id}\") ... üëâ This ensures that if the same client retries due to a timeout, the system knows it‚Äôs the same operation, not a new one.\n2Ô∏è‚É£ Persist Before Calling Upstream the-api must persist the operation before invoking the external service to avoid dual-write problems.\nfrom datetime import datetime from sqlmodel import SQLModel, Field class Operation(SQLModel, table=True): id: str = Field(primary_key=True) status: str = Field(default=\"PENDING\") created_at: datetime = Field(default_factory=datetime.utcnow) updated_at: datetime = Field(default_factory=datetime.utcnow) # Inside your handler operation = Operation(id=operation_id) session.add(operation) session.commit() If the process crashes right after this commit, the pending operation is still stored and can be retried later.\n3Ô∏è‚É£ Resilient HTTP Client (Timeout + Retry + Circuit Breaker) import httpx from tenacity import retry, stop_after_attempt, wait_exponential_jitter import pybreaker breaker = pybreaker.CircuitBreaker(fail_max=5, reset_timeout=30) @retry(stop=stop_after_attempt(3), wait=wait_exponential_jitter(1, 3)) @breaker async def call_upstream(url: str, payload: dict, operation_id: str): async with httpx.AsyncClient(timeout=httpx.Timeout(5.0, connect=3.0)) as client: r = await client.post(url, json=payload, headers={\"Idempotency-Key\": operation_id}) r.raise_for_status() return r.json() üìç Explanation\nTimeout prevents blocking forever Retry with jitter handles transient errors Circuit Breaker isolates failing dependencies and prevents cascading failures 4Ô∏è‚É£ Handle Timeouts Gracefully ‚Äî Respond 202 Accepted If the upstream doesn‚Äôt respond, don‚Äôt lie to the client.\nReturn a 202 Accepted with the operation_id and a /status URL.\nfrom fastapi.responses import JSONResponse @app.post(\"/v1/test\") async def test_endpoint(idempotency_key: str | None = Header(None)): operation_id = idempotency_key or str(uuid.uuid7()) try: data = await call_upstream(\"https://upstream/api\", {\"foo\": \"bar\"}, operation_id) # Confirm and persist result return {\"status\": \"CONFIRMED\", \"operation_id\": operation_id} except Exception as exc: # Mark as UNKNOWN and return 202 return JSONResponse( {\"status\": \"UNKNOWN\", \"operation_id\": operation_id, \"detail\": str(exc)}, status_code=202, ) Now the client can poll GET /v1/ops/{operation_id} until the operation is reconciled.\n5Ô∏è‚É£ Reconciliation ‚Äî Closing the Black Hole A background worker periodically scans operations with status UNKNOWN and verifies whether the upstream succeeded.\nfrom celery import Celery celery_app = Celery(broker=\"redis://localhost\") @celery_app.task def reconcile_operation(operation_id: str): try: result = call_upstream(\"https://upstream/status\", {\"op_id\": operation_id}, operation_id) if result.get(\"status\") == \"done\": mark_confirmed(operation_id) else: mark_failed(operation_id) except Exception: pass # retry later üí° Common reconciliation sources\nUpstream provides /status/{operation_id} Webhooks from upstream Daily batch exports or financial statements 6Ô∏è‚É£ Ledger and Compensation When the upstream is a true black box, you can‚Äôt know for sure whether it executed (C).\nIn that case, you need compensating entries, not deletions ‚Äî especially for financial data.\nclass LedgerEntry(SQLModel, table=True): id: str = Field(primary_key=True) operation_id: str account: str amount: float direction: str # \"DR\" or \"CR\" created_at: datetime = Field(default_factory=datetime.utcnow) If you detect a duplicate or invalid operation:\ndef compensate(entry: LedgerEntry): reverse = LedgerEntry( id=str(uuid.uuid7()), operation_id=entry.operation_id, account=entry.account, amount=entry.amount, direction=\"CR\" if entry.direction == \"DR\" else \"DR\", ) session.add(reverse) session.commit() üí¨ In finance, you never delete ‚Äî you offset.\n7Ô∏è‚É£ Outbox Pattern ‚Äî Guaranteed Delivery The outbox pattern ensures events are published even if the process crashes after committing the transaction.\nclass OutboxEvent(SQLModel, table=True): id: str = Field(primary_key=True) aggregate: str payload: str published_at: datetime | None = None def create_operation(payload): operation = Operation(id=payload[\"op_id\"], status=\"PENDING\") outbox = OutboxEvent(aggregate=\"operation\", payload=json.dumps(payload)) with session.begin(): session.add(operation) session.add(outbox) A separate worker scans the outbox and sends events to a message broker (e.g., Kafka, RabbitMQ, or Celery).\n8Ô∏è‚É£ Sagas ‚Äî Orchestrating Multi-Step Consistency For multi-service transactions, use the Saga pattern:\neach step has a compensating action if the next one fails.\nfrom dataclasses import dataclass, field from typing import Awaitable, Callable StepFn = Callable[[], Awaitable[None]] CompFn = Callable[[], Awaitable[None]] @dataclass class Step: do: StepFn compensate: CompFn @dataclass class Saga: steps: list[Step] = field(default_factory=list) async def execute(self): done = [] try: for s in self.steps: await s.do() done.append(s) except Exception: for s in reversed(done): await s.compensate() raise Example: create order ‚Üí reserve stock ‚Üí charge payment.\nIf payment fails, cancel stock and cancel order.\n‚úÖ Final Checklist Pattern Purpose Operation ID Unique identity per transaction Idempotency Avoid duplicate effects Timeout + Retry + Breaker Network resilience Persist-before-call Auditability Outbox + Worker Guaranteed delivery 202 + /status Transparent uncertainty Reconciliation Close ambiguous states Ledger Compensate instead of deleting Sagas Cross-service consistency üìà Observability and Metrics Track these KPIs to keep your system healthy:\np95 latency per upstream call % of timeouts Number and age of UNKNOWN operations Circuit breaker open duration Outbox/DLQ backlog % of compensated operations üìö Recommended Reading Designing Data-Intensive Applications ‚Äî Martin Kleppmann Microservices Patterns ‚Äî Chris Richardson Stripe Engineering Blog: Idempotency in APIs Google SRE Workbook üí¨ Have you ever faced this ‚Äúambiguous timeout‚Äù issue?\nHow did you solve it in your system?\nShare your thoughts or tag me on LinkedIn with #CleanArchitecture #Microservices.\nLinkedIn GitHub ",
  "wordCount" : "970",
  "inLanguage": "en",
  "image":"https://fredericogago.github.io/frederico-gago/images/cover/microservices-resilience-diagram.png","datePublished": "2025-10-06T18:55:59+01:00",
  "dateModified": "2025-10-06T18:55:59+01:00",
  "author":{
    "@type": "Person",
    "name": "Frederico Gago"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://fredericogago.github.io/frederico-gago/posts/microservices-resilience-timeout/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Frederico Gago ‚Äì Tech Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://fredericogago.github.io/frederico-gago/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://fredericogago.github.io/frederico-gago/" accesskey="h" title="Frederico Gago ‚Äì Tech Blog (Alt + H)">Frederico Gago ‚Äì Tech Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://fredericogago.github.io/frederico-gago/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://fredericogago.github.io/frederico-gago/contact/" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
            <li>
                <a href="https://fredericogago.github.io/frederico-gago/posts/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://fredericogago.github.io/frederico-gago/">Home</a>&nbsp;¬ª&nbsp;<a href="https://fredericogago.github.io/frederico-gago/posts/">Blog</a></div>
    <h1 class="post-title entry-hint-parent">
      How to Handle Microservice Failures: The Ambiguous Timeout Dilemma
    </h1>
    <div class="post-description">
      When a service call times out and you don‚Äôt know what happened ‚Äî how do you stay correct, consistent, and auditable? Let&#39;s explore resilience, idempotency, and compensation patterns with Python examples.
    </div>
    <div class="post-meta"><span title='2025-10-06 18:55:59 +0100 WEST'>October 6, 2025</span>&nbsp;¬∑&nbsp;5 min&nbsp;¬∑&nbsp;Frederico Gago

</div>
  </header> 
<figure class="entry-cover">
        <img loading="eager" src="https://fredericogago.github.io/frederico-gago/images/cover/microservices-resilience-diagram.png" alt="Microservices Resilience Cover Image">
        
</figure>
  <div class="post-content"><h1 id="-the-classic-problem-when-a-service-doesnt-respond">üß© The Classic Problem: When a Service Doesn‚Äôt Respond<a hidden class="anchor" aria-hidden="true" href="#-the-classic-problem-when-a-service-doesnt-respond">#</a></h1>
<p>Imagine the following flow in a service-oriented system:</p>
<pre tabindex="0"><code>Client ‚Üí the-api ‚Üí the-upstream ‚Üí Database
</code></pre><p>1Ô∏è‚É£ The client calls <code>the-api/v1/test</code><br>
2Ô∏è‚É£ <code>the-api</code> calls <code>the-upstream</code><br>
3Ô∏è‚É£ <code>the-upstream</code> writes data into its own database<br>
4Ô∏è‚É£ It replies <code>OK</code> to <code>the-api</code><br>
5Ô∏è‚É£ <code>the-api</code> stores the result in its database and replies <code>OK</code> to the client</p>
<p>Everything works fine ‚Äî until step 4 (D) fails because of a <strong>network partition</strong> or <strong>timeout</strong>.<br>
Now, <code>the-api</code> doesn‚Äôt know if the upstream actually wrote the data or not.<br>
You can‚Äôt safely commit your local write ‚Äî and you can‚Äôt confidently reply to the client.</p>
<p>This is the <strong>ambiguous timeout problem</strong>, one of the hardest challenges in distributed systems.</p>
<hr>
<h1 id="-the-goal">üéØ The Goal<a hidden class="anchor" aria-hidden="true" href="#-the-goal">#</a></h1>
<p>We need to ensure that:</p>
<ul>
<li>No operation executes twice (<strong>idempotency</strong>)</li>
<li>No data is lost (<strong>durability</strong>)</li>
<li>Every step is <strong>auditable</strong></li>
<li>The system remains <strong>useful</strong> even under partial failure (<strong>resilience</strong>)</li>
</ul>
<hr>
<h1 id="-the-design-philosophy">üèóÔ∏è The Design Philosophy<a hidden class="anchor" aria-hidden="true" href="#-the-design-philosophy">#</a></h1>
<p>The key is simple:<br>
üëâ <strong>First record the intent</strong>,<br>
üëâ <strong>Then attempt execution</strong>,<br>
and if anything fails, have a way to <strong>reconcile</strong> later.</p>
<hr>
<h2 id="1-operation-id-and-idempotency">1Ô∏è‚É£ Operation ID and Idempotency<a hidden class="anchor" aria-hidden="true" href="#1-operation-id-and-idempotency">#</a></h2>
<p>Each operation must have a unique identifier ‚Äî created in <code>the-api</code> and passed along all downstream calls.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">uuid</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Header</span><span class="p">,</span> <span class="n">HTTPException</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.post</span><span class="p">(</span><span class="s2">&#34;/v1/test&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">test_endpoint</span><span class="p">(</span><span class="n">idempotency_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">operation_id</span> <span class="o">=</span> <span class="n">idempotency_key</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid7</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Store operation as PENDING</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;New operation: </span><span class="si">{</span><span class="n">operation_id</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span></code></pre></div><p>üëâ This ensures that if the same client retries due to a timeout, the system knows it‚Äôs the <strong>same operation</strong>, not a new one.</p>
<hr>
<h2 id="2-persist-before-calling-upstream">2Ô∏è‚É£ Persist Before Calling Upstream<a hidden class="anchor" aria-hidden="true" href="#2-persist-before-calling-upstream">#</a></h2>
<p><code>the-api</code> must persist the operation <strong>before</strong> invoking the external service to avoid dual-write problems.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sqlmodel</span> <span class="kn">import</span> <span class="n">SQLModel</span><span class="p">,</span> <span class="n">Field</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Operation</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&#34;PENDING&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">updated_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Inside your handler</span>
</span></span><span class="line"><span class="cl"><span class="n">operation</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">operation_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span></code></pre></div><p>If the process crashes right after this commit, the pending operation is still stored and can be retried later.</p>
<hr>
<h2 id="3-resilient-http-client-timeout--retry--circuit-breaker">3Ô∏è‚É£ Resilient HTTP Client (Timeout + Retry + Circuit Breaker)<a hidden class="anchor" aria-hidden="true" href="#3-resilient-http-client-timeout--retry--circuit-breaker">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">httpx</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">stop_after_attempt</span><span class="p">,</span> <span class="n">wait_exponential_jitter</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pybreaker</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">breaker</span> <span class="o">=</span> <span class="n">pybreaker</span><span class="o">.</span><span class="n">CircuitBreaker</span><span class="p">(</span><span class="n">fail_max</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">reset_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@retry</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">wait</span><span class="o">=</span><span class="n">wait_exponential_jitter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nd">@breaker</span>
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">call_upstream</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">operation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="o">.</span><span class="n">Timeout</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="mf">3.0</span><span class="p">))</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;Idempotency-Key&#34;</span><span class="p">:</span> <span class="n">operation_id</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span></code></pre></div><p>üìç <strong>Explanation</strong></p>
<ul>
<li><strong>Timeout</strong> prevents blocking forever</li>
<li><strong>Retry</strong> with jitter handles transient errors</li>
<li><strong>Circuit Breaker</strong> isolates failing dependencies and prevents cascading failures</li>
</ul>
<hr>
<h2 id="4-handle-timeouts-gracefully--respond-202-accepted">4Ô∏è‚É£ Handle Timeouts Gracefully ‚Äî Respond 202 Accepted<a hidden class="anchor" aria-hidden="true" href="#4-handle-timeouts-gracefully--respond-202-accepted">#</a></h2>
<p>If the upstream doesn‚Äôt respond, don‚Äôt lie to the client.<br>
Return a <code>202 Accepted</code> with the <code>operation_id</code> and a <code>/status</code> URL.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">fastapi.responses</span> <span class="kn">import</span> <span class="n">JSONResponse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.post</span><span class="p">(</span><span class="s2">&#34;/v1/test&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">test_endpoint</span><span class="p">(</span><span class="n">idempotency_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">operation_id</span> <span class="o">=</span> <span class="n">idempotency_key</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid7</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_upstream</span><span class="p">(</span><span class="s2">&#34;https://upstream/api&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&#34;foo&#34;</span><span class="p">:</span> <span class="s2">&#34;bar&#34;</span><span class="p">},</span> <span class="n">operation_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Confirm and persist result</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;CONFIRMED&#34;</span><span class="p">,</span> <span class="s2">&#34;operation_id&#34;</span><span class="p">:</span> <span class="n">operation_id</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Mark as UNKNOWN and return 202</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;UNKNOWN&#34;</span><span class="p">,</span> <span class="s2">&#34;operation_id&#34;</span><span class="p">:</span> <span class="n">operation_id</span><span class="p">,</span> <span class="s2">&#34;detail&#34;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)},</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_code</span><span class="o">=</span><span class="mi">202</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span></code></pre></div><p>Now the client can poll <code>GET /v1/ops/{operation_id}</code> until the operation is reconciled.</p>
<hr>
<h2 id="5-reconciliation--closing-the-black-hole">5Ô∏è‚É£ Reconciliation ‚Äî Closing the Black Hole<a hidden class="anchor" aria-hidden="true" href="#5-reconciliation--closing-the-black-hole">#</a></h2>
<p>A background worker periodically scans operations with status <code>UNKNOWN</code> and verifies whether the upstream succeeded.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">celery_app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s2">&#34;redis://localhost&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@celery_app.task</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">reconcile_operation</span><span class="p">(</span><span class="n">operation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">call_upstream</span><span class="p">(</span><span class="s2">&#34;https://upstream/status&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&#34;op_id&#34;</span><span class="p">:</span> <span class="n">operation_id</span><span class="p">},</span> <span class="n">operation_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;status&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;done&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">mark_confirmed</span><span class="p">(</span><span class="n">operation_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">mark_failed</span><span class="p">(</span><span class="n">operation_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>  <span class="c1"># retry later</span>
</span></span></code></pre></div><p>üí° <strong>Common reconciliation sources</strong></p>
<ul>
<li>Upstream provides <code>/status/{operation_id}</code></li>
<li>Webhooks from upstream</li>
<li>Daily batch exports or financial statements</li>
</ul>
<hr>
<h2 id="6-ledger-and-compensation">6Ô∏è‚É£ Ledger and Compensation<a hidden class="anchor" aria-hidden="true" href="#6-ledger-and-compensation">#</a></h2>
<p>When the upstream is a true black box, you can‚Äôt know for sure whether it executed (C).<br>
In that case, you need <strong>compensating entries</strong>, not deletions ‚Äî especially for financial data.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LedgerEntry</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">operation_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">account</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#34;DR&#34; or &#34;CR&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>
</span></span></code></pre></div><p>If you detect a duplicate or invalid operation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">compensate</span><span class="p">(</span><span class="n">entry</span><span class="p">:</span> <span class="n">LedgerEntry</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">reverse</span> <span class="o">=</span> <span class="n">LedgerEntry</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nb">id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid7</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">        <span class="n">operation_id</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">operation_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">account</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">amount</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">direction</span><span class="o">=</span><span class="s2">&#34;CR&#34;</span> <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s2">&#34;DR&#34;</span> <span class="k">else</span> <span class="s2">&#34;DR&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span></code></pre></div><blockquote>
<p>üí¨ In finance, you never delete ‚Äî you <strong>offset</strong>.</p></blockquote>
<hr>
<h2 id="7-outbox-pattern--guaranteed-delivery">7Ô∏è‚É£ Outbox Pattern ‚Äî Guaranteed Delivery<a hidden class="anchor" aria-hidden="true" href="#7-outbox-pattern--guaranteed-delivery">#</a></h2>
<p>The <strong>outbox pattern</strong> ensures events are published even if the process crashes after committing the transaction.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">OutboxEvent</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aggregate</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">published_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create_operation</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">operation</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">payload</span><span class="p">[</span><span class="s2">&#34;op_id&#34;</span><span class="p">],</span> <span class="n">status</span><span class="o">=</span><span class="s2">&#34;PENDING&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">outbox</span> <span class="o">=</span> <span class="n">OutboxEvent</span><span class="p">(</span><span class="n">aggregate</span><span class="o">=</span><span class="s2">&#34;operation&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">outbox</span><span class="p">)</span>
</span></span></code></pre></div><p>A separate worker scans the outbox and sends events to a message broker (e.g., Kafka, RabbitMQ, or Celery).</p>
<hr>
<h2 id="8-sagas--orchestrating-multi-step-consistency">8Ô∏è‚É£ Sagas ‚Äî Orchestrating Multi-Step Consistency<a hidden class="anchor" aria-hidden="true" href="#8-sagas--orchestrating-multi-step-consistency">#</a></h2>
<p>For multi-service transactions, use the <strong>Saga pattern</strong>:<br>
each step has a <strong>compensating action</strong> if the next one fails.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Callable</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">StepFn</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl"><span class="n">CompFn</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Step</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">do</span><span class="p">:</span> <span class="n">StepFn</span>
</span></span><span class="line"><span class="cl">    <span class="n">compensate</span><span class="p">:</span> <span class="n">CompFn</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Saga</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">steps</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Step</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">await</span> <span class="n">s</span><span class="o">.</span><span class="n">do</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">done</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">await</span> <span class="n">s</span><span class="o">.</span><span class="n">compensate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span>
</span></span></code></pre></div><blockquote>
<p>Example: create order ‚Üí reserve stock ‚Üí charge payment.<br>
If payment fails, cancel stock and cancel order.</p></blockquote>
<hr>
<h1 id="-final-checklist">‚úÖ Final Checklist<a hidden class="anchor" aria-hidden="true" href="#-final-checklist">#</a></h1>
<table>
  <thead>
      <tr>
          <th>Pattern</th>
          <th>Purpose</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Operation ID</strong></td>
          <td>Unique identity per transaction</td>
      </tr>
      <tr>
          <td><strong>Idempotency</strong></td>
          <td>Avoid duplicate effects</td>
      </tr>
      <tr>
          <td><strong>Timeout + Retry + Breaker</strong></td>
          <td>Network resilience</td>
      </tr>
      <tr>
          <td><strong>Persist-before-call</strong></td>
          <td>Auditability</td>
      </tr>
      <tr>
          <td><strong>Outbox + Worker</strong></td>
          <td>Guaranteed delivery</td>
      </tr>
      <tr>
          <td><strong>202 + /status</strong></td>
          <td>Transparent uncertainty</td>
      </tr>
      <tr>
          <td><strong>Reconciliation</strong></td>
          <td>Close ambiguous states</td>
      </tr>
      <tr>
          <td><strong>Ledger</strong></td>
          <td>Compensate instead of deleting</td>
      </tr>
      <tr>
          <td><strong>Sagas</strong></td>
          <td>Cross-service consistency</td>
      </tr>
  </tbody>
</table>
<hr>
<h1 id="-observability-and-metrics">üìà Observability and Metrics<a hidden class="anchor" aria-hidden="true" href="#-observability-and-metrics">#</a></h1>
<p>Track these KPIs to keep your system healthy:</p>
<ul>
<li>p95 latency per upstream call</li>
<li>% of timeouts</li>
<li>Number and age of <code>UNKNOWN</code> operations</li>
<li>Circuit breaker open duration</li>
<li>Outbox/DLQ backlog</li>
<li>% of compensated operations</li>
</ul>
<hr>
<h1 id="-recommended-reading">üìö Recommended Reading<a hidden class="anchor" aria-hidden="true" href="#-recommended-reading">#</a></h1>
<ul>
<li><em>Designing Data-Intensive Applications</em> ‚Äî Martin Kleppmann</li>
<li><em>Microservices Patterns</em> ‚Äî Chris Richardson</li>
<li><a href="https://stripe.com/blog/idempotency">Stripe Engineering Blog: Idempotency in APIs</a></li>
<li><a href="https://sre.google/workbook/">Google SRE Workbook</a></li>
</ul>
<hr>
<p>üí¨ <strong>Have you ever faced this ‚Äúambiguous timeout‚Äù issue?</strong><br>
How did you solve it in your system?</p>
<p>Share your thoughts or tag me on LinkedIn with <strong>#CleanArchitecture #Microservices</strong>.</p>
<ul>
<li><a href="https://www.linkedin.com/in/frederico-gago-5849281aa">LinkedIn</a></li>
<li><a href="https://github.com/fredericogago">GitHub</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://fredericogago.github.io/frederico-gago/tags/microservices/">Microservices</a></li>
      <li><a href="https://fredericogago.github.io/frederico-gago/tags/resilience/">Resilience</a></li>
      <li><a href="https://fredericogago.github.io/frederico-gago/tags/python/">Python</a></li>
      <li><a href="https://fredericogago.github.io/frederico-gago/tags/fastapi/">FastAPI</a></li>
      <li><a href="https://fredericogago.github.io/frederico-gago/tags/clean-architecture/">Clean Architecture</a></li>
      <li><a href="https://fredericogago.github.io/frederico-gago/tags/distributed-systems/">Distributed Systems</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://fredericogago.github.io/frederico-gago/posts/uow-sqlalchemy-python/">
    <span class="title">Next ¬ª</span>
    <br>
    <span>Unit of Work (UoW) in Python with SQLAlchemy: explicit transactions, savepoints, and outbox</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://fredericogago.github.io/frederico-gago/">Frederico Gago ‚Äì Tech Blog</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
