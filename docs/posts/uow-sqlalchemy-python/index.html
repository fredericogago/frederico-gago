<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Unit of Work (UoW) in Python with SQLAlchemy: explicit transactions, savepoints, and outbox | Frederico Gago ‚Äì Tech Blog</title>
<meta name="keywords" content="Python, SQLAlchemy, FastAPI, Clean Architecture, Unit of Work, Architecture">
<meta name="description" content="How I designed an asynchronous, scalable UoW with SQLAlchemy: explicit transaction boundary, nesting with savepoints, transactional outbox, idempotency, and a manager that works across API, CLI, and workers.">
<meta name="author" content="Frederico Gago">
<link rel="canonical" href="https://fredericogago.github.io/frederico-gago/posts/uow-sqlalchemy-python/">
<link crossorigin="anonymous" href="https://fredericogago.github.io/frederico-gago/assets/css/stylesheet.2211ca3164be7830024f6aad2b3a2e520843a64f8f048445c3401c1249aa051d.css" integrity="sha256-IhHKMWS&#43;eDACT2qtKzouUghDpk&#43;PBIRFw0AcEkmqBR0=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://fredericogago.github.io/frederico-gago/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://fredericogago.github.io/frederico-gago/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://fredericogago.github.io/frederico-gago/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://fredericogago.github.io/frederico-gago/apple-touch-icon.png">
<link rel="mask-icon" href="https://fredericogago.github.io/frederico-gago/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://fredericogago.github.io/frederico-gago/posts/uow-sqlalchemy-python/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://fredericogago.github.io/frederico-gago/posts/uow-sqlalchemy-python/">
  <meta property="og:site_name" content="Frederico Gago ‚Äì Tech Blog">
  <meta property="og:title" content="Unit of Work (UoW) in Python with SQLAlchemy: explicit transactions, savepoints, and outbox">
  <meta property="og:description" content="How I designed an asynchronous, scalable UoW with SQLAlchemy: explicit transaction boundary, nesting with savepoints, transactional outbox, idempotency, and a manager that works across API, CLI, and workers.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-09-26T07:54:52+01:00">
    <meta property="article:modified_time" content="2025-09-26T07:54:52+01:00">
    <meta property="article:tag" content="Python">
    <meta property="article:tag" content="SQLAlchemy">
    <meta property="article:tag" content="FastAPI">
    <meta property="article:tag" content="Clean Architecture">
    <meta property="article:tag" content="Unit of Work">
    <meta property="article:tag" content="Architecture">
    <meta property="og:image" content="https://fredericogago.github.io/frederico-gago/images/cover/uow-cover.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://fredericogago.github.io/frederico-gago/images/cover/uow-cover.png">
<meta name="twitter:title" content="Unit of Work (UoW) in Python with SQLAlchemy: explicit transactions, savepoints, and outbox">
<meta name="twitter:description" content="How I designed an asynchronous, scalable UoW with SQLAlchemy: explicit transaction boundary, nesting with savepoints, transactional outbox, idempotency, and a manager that works across API, CLI, and workers.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blog",
      "item": "https://fredericogago.github.io/frederico-gago/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Unit of Work (UoW) in Python with SQLAlchemy: explicit transactions, savepoints, and outbox",
      "item": "https://fredericogago.github.io/frederico-gago/posts/uow-sqlalchemy-python/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Unit of Work (UoW) in Python with SQLAlchemy: explicit transactions, savepoints, and outbox",
  "name": "Unit of Work (UoW) in Python with SQLAlchemy: explicit transactions, savepoints, and outbox",
  "description": "How I designed an asynchronous, scalable UoW with SQLAlchemy: explicit transaction boundary, nesting with savepoints, transactional outbox, idempotency, and a manager that works across API, CLI, and workers.",
  "keywords": [
    "Python", "SQLAlchemy", "FastAPI", "Clean Architecture", "Unit of Work", "Architecture"
  ],
  "articleBody": "Building a Production-Grade Unit of Work (UoW) System in Python with SQLAlchemy When you build complex applications with databases, services, and background jobs, you eventually run into the transaction problem:\nHow do I guarantee all operations happen atomically? How do I handle nested scopes (reuse vs rollback)? How do I ensure events are only published once? How do I protect against duplicate commits when retries happen? The solution is a Unit of Work (UoW) system ‚Äî a design pattern that wraps all your persistence operations in a clear, explicit transaction boundary.\nIn this post, I‚Äôll show you how I built a production-grade UoW system in Python 3.13 using async SQLAlchemy, with:\nExplicit transaction boundaries Safe nesting (reuse vs savepoint) Read-only transactions Transactional outbox for events Idempotency key protection Great testing story üö® The Problem: Repos Without Boundaries A naive service might look like this:\nuser = await user_repo.create(User(...)) order = await order_repo.create(Order(...)) await email_service.send_order_confirmation(order) But what if the order commit fails while the email has already been sent? You‚Äôve just created an inconsistent state.\nWithout a transaction boundary, repositories can be called arbitrarily, leading to partial failures and ghost side effects.\n‚úÖ The Solution: Unit of Work + Manager The UoW system enforces a strict rule:\nüëâ All repos must be accessed through a UoW scope.\nA service now looks like this:\nasync with uow_manager.enter(mode=UoWMode.REUSE) as uow: user = await uow.repos.user.create(User(...)) order = await uow.repos.order.create(Order(...)) uow.add_event(\"order.created\", {\"order_id\": order.id}) At the end of the scope:\nIf everything succeeded ‚Üí commit. If something failed ‚Üí rollback. Events are persisted only on outermost commit. üßë‚Äçüíª The Code SqlAlchemyUoWBase This is the core UoW implementation. It wraps an AsyncSession, tracks events and idempotency keys, and handles nesting rules.\nclass SqlAlchemyUoWBase[IRepos](IUnitOfWork[IRepos]): \"\"\"Unit-of-Work facade with nesting support (reuse vs savepoint).\"\"\" def __init__( self, session: AsyncSession, level: int, *, read_only: bool = False, event_sink: EventSink, idem_box: IdemBox, ) -\u003e None: self._s = session self._level = level self._read_only = read_only self._active = True self._tx = None self._events = event_sink self._idem_box = idem_box self._repos: IRepos | None = None ... UoWManager The manager ensures that:\nSessions are reused across nested scopes Events/idempotency are shared at all levels Commit/rollback/close are coordinated correctly class UoWManager[UowBaseT, IRepos](IUoWManager): \"\"\"Creates UoW scopes over a shared AsyncSession with nesting support.\"\"\" @asynccontextmanager async def enter(self, *, mode: UoWMode = UoWMode.REUSE, read_only: bool = False): mark_enter(self._label) try: if self._session is None: self._session = self._sf() self._event_sink = EventSink(items=[]) self._idem_box = IdemBox() level = len(self._stack) + 1 nested = level \u003e 1 and mode is UoWMode.SAVEPOINT start_tx = (level == 1) or nested uow = self._uow_cls( self._session, level, read_only=read_only, event_sink=self._event_sink, idem_box=self._idem_box, ) uow.set_repos(self._repo_factory(self._session)) self._stack.append(uow) await uow.start(start_tx=start_tx) try: yield uow await uow.commit(started_tx=start_tx) except Exception: await uow.rollback(started_tx=start_tx) raise finally: self._stack.pop() if not self._stack: await self._session.close() self._session = None self._event_sink = None self._idem_box = None finally: mark_exit(self._label) üîÑ Visual Flow Outermost Transaction (Level 1) BEGIN TRANSACTION ... repo operations ... COMMIT ‚Üí Flush outbox ‚Üí Persist idempotency key Nested Reuse (Level \u003e 1, REUSE) (no BEGIN, reuse outer tx) ... repo operations ... (no COMMIT, outer decides) Nested Savepoint (Level \u003e 1, SAVEPOINT) BEGIN NESTED (savepoint) ... repo operations ... RELEASE SAVEPOINT üì¶ Events + Idempotency Both inner and outer scopes share the same sinks:\nEventSink ‚Üí events are buffered and only persisted to the outbox table on the outermost commit IdemBox ‚Üí idempotency key ensures retries don‚Äôt double-commit uow.add_event(\"user.created\", {\"id\": 123}) uow.set_idempotency_key(\"req-uuid\") # Outer commit persists: # - Outbox row # - Idempotency key row üìä Quick Comparison Mode Behavior Use Case OUTERMOST Starts real transaction, commits, flushes events Normal service call REUSE Shares outer transaction, no BEGIN/COMMIT Helpers that must be atomic with parent SAVEPOINT Creates nested savepoint, rollback safe Risky operations (e.g., optional steps) üß™ Testing with Fake UoWManager One of the biggest benefits of this design is that you can easily fake the UoW in tests.\nInstead of creating a real SQLAlchemy session, you inject in-memory repositories.\nFake Manager Example class FakeConfigRepo(IConfigRepo): def __init__(self): self.items = [] async def get_configurations_by_group_name(self, group_name): return [i for i in self.items if i.group == group_name] class FakeRepos(IConfigRepos): def __init__(self): self._config = FakeConfigRepo() @property def config(self) -\u003e IConfigRepo: return self._config class FakeUoW(IUnitOfWork[FakeRepos]): def __init__(self): self._repos = FakeRepos() self._active = True @property def repos(self) -\u003e FakeRepos: return self._repos async def commit(self, *, started_tx: bool) -\u003e None: ... async def rollback(self, *, started_tx: bool) -\u003e None: ... async def close(self) -\u003e None: ... def add_event(self, *, event_type: str, payload: dict) -\u003e None: ... def set_idempotency_key(self, key: str | None) -\u003e None: ... @property def level(self) -\u003e int: return 1 @property def is_active(self) -\u003e bool: return self._active class FakeUoWManager(IUoWManager): async def enter(self, *, mode=UoWMode.REUSE, read_only=False): uow = FakeUoW() yield uow Example Test async def test_get_configs_returns_items(): mgr = FakeUoWManager() async with mgr.enter() as uow: uow.repos.config.items.append(ConfigItem(group=\"general\", key=\"x\", value=\"1\")) service = ConfigService(uow.repos.config) result = await service.get_configurations_by_group_name(\"general\") assert result.is_ok() assert len(result.unwrap()) == 1 This way:\nNo database required No transactions opened Service logic is testable in isolation ‚ö° Performance Notes One subtle advantage of this design is control over transaction cost.\nREUSE mode is the fastest:\nNo new transaction, no savepoint, no roundtrips. Best when nested operations are always safe to run under the parent scope. SAVEPOINT mode adds overhead:\nEach savepoint requires SQL roundtrips (SAVEPOINT, ROLLBACK TO, RELEASE). Use it when you need to isolate risky steps without aborting the entire parent transaction. Example rule of thumb:\nUse REUSE for 95% of nested calls (normal service-to-service collaboration). Use SAVEPOINT sparingly (e.g., optional third-party calls, best-effort cleanups). This balance keeps transactions fast, predictable, and resilient.\nüèÅ Closing Thoughts The Unit of Work pattern is not just a persistence abstraction. It‚Äôs a contract:\nEvery service runs inside a transaction. Events are only published if the transaction commits. Duplicate commits are prevented with idempotency. With this system, my services are safer, my tests are easier, and my architecture is cleaner.\nIn asynchronous apps built with SQLAlchemy + FastAPI, a combination of UoW Manager + UoW Base delivers safety, testability, and a clean architecture.\nüí¨ Do you prefer implicit context (via contextvars) or explicit scopes like this? Share your thoughts!\nLinkedIn GitHub ",
  "wordCount" : "1009",
  "inLanguage": "en",
  "image":"https://fredericogago.github.io/frederico-gago/images/cover/uow-cover.png","datePublished": "2025-09-26T07:54:52+01:00",
  "dateModified": "2025-09-26T07:54:52+01:00",
  "author":{
    "@type": "Person",
    "name": "Frederico Gago"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://fredericogago.github.io/frederico-gago/posts/uow-sqlalchemy-python/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Frederico Gago ‚Äì Tech Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://fredericogago.github.io/frederico-gago/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://fredericogago.github.io/frederico-gago/" accesskey="h" title="Frederico Gago ‚Äì Tech Blog (Alt + H)">Frederico Gago ‚Äì Tech Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://fredericogago.github.io/frederico-gago/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://fredericogago.github.io/frederico-gago/contact/" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
            <li>
                <a href="https://fredericogago.github.io/frederico-gago/posts/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://fredericogago.github.io/frederico-gago/">Home</a>&nbsp;¬ª&nbsp;<a href="https://fredericogago.github.io/frederico-gago/posts/">Blog</a></div>
    <h1 class="post-title entry-hint-parent">
      Unit of Work (UoW) in Python with SQLAlchemy: explicit transactions, savepoints, and outbox
    </h1>
    <div class="post-description">
      How I designed an asynchronous, scalable UoW with SQLAlchemy: explicit transaction boundary, nesting with savepoints, transactional outbox, idempotency, and a manager that works across API, CLI, and workers.
    </div>
    <div class="post-meta"><span title='2025-09-26 07:54:52 +0100 WEST'>September 26, 2025</span>&nbsp;¬∑&nbsp;5 min&nbsp;¬∑&nbsp;Frederico Gago

</div>
  </header> 
<figure class="entry-cover">
        <img loading="eager" src="https://fredericogago.github.io/frederico-gago/images/cover/uow-cover.png" alt="Conceptual diagram of a Unit of Work with application and persistence layers">
        
</figure>
  <div class="post-content"><h1 id="building-a-production-grade-unit-of-work-uow-system-in-python-with-sqlalchemy">Building a Production-Grade Unit of Work (UoW) System in Python with SQLAlchemy<a hidden class="anchor" aria-hidden="true" href="#building-a-production-grade-unit-of-work-uow-system-in-python-with-sqlalchemy">#</a></h1>
<p>When you build complex applications with <strong>databases, services, and background jobs</strong>, you eventually run into the <strong>transaction problem</strong>:</p>
<ul>
<li>How do I guarantee all operations happen <strong>atomically</strong>?</li>
<li>How do I handle <strong>nested scopes</strong> (reuse vs rollback)?</li>
<li>How do I ensure <strong>events are only published once</strong>?</li>
<li>How do I protect against <strong>duplicate commits</strong> when retries happen?</li>
</ul>
<p>The solution is a <strong>Unit of Work (UoW) system</strong> ‚Äî a design pattern that <strong>wraps all your persistence operations in a clear, explicit transaction boundary</strong>.</p>
<p>In this post, I‚Äôll show you how I built a <strong>production-grade UoW system in Python 3.13</strong> using <strong>async SQLAlchemy</strong>, with:</p>
<ul>
<li>Explicit transaction boundaries</li>
<li>Safe nesting (reuse vs savepoint)</li>
<li>Read-only transactions</li>
<li>Transactional outbox for events</li>
<li>Idempotency key protection</li>
<li>Great testing story</li>
</ul>
<hr>
<h2 id="-the-problem-repos-without-boundaries">üö® The Problem: Repos Without Boundaries<a hidden class="anchor" aria-hidden="true" href="#-the-problem-repos-without-boundaries">#</a></h2>
<p>A naive service might look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_repo</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">User</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="n">order_repo</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">Order</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">await</span> <span class="n">email_service</span><span class="o">.</span><span class="n">send_order_confirmation</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</span></span></code></pre></div><p>But what if the order commit fails while the email has already been sent?
You‚Äôve just created an inconsistent state.</p>
<p>Without a transaction boundary, repositories can be called arbitrarily, leading to partial failures and ghost side effects.</p>
<hr>
<h2 id="-the-solution-unit-of-work--manager">‚úÖ The Solution: Unit of Work + Manager<a hidden class="anchor" aria-hidden="true" href="#-the-solution-unit-of-work--manager">#</a></h2>
<p>The <strong>UoW system</strong> enforces a strict rule:</p>
<p>üëâ <strong>All repos must be accessed through a UoW scope.</strong></p>
<p>A service now looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">async</span> <span class="k">with</span> <span class="n">uow_manager</span><span class="o">.</span><span class="n">enter</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">UoWMode</span><span class="o">.</span><span class="n">REUSE</span><span class="p">)</span> <span class="k">as</span> <span class="n">uow</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">uow</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">User</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="n">uow</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">Order</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">uow</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s2">&#34;order.created&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&#34;order_id&#34;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
</span></span></code></pre></div><p>At the end of the scope:</p>
<ul>
<li>If everything succeeded ‚Üí <strong>commit</strong>.</li>
<li>If something failed ‚Üí <strong>rollback</strong>.</li>
<li>Events are persisted only on <strong>outermost commit</strong>.</li>
</ul>
<hr>
<h2 id="-the-code">üßë‚Äçüíª The Code<a hidden class="anchor" aria-hidden="true" href="#-the-code">#</a></h2>
<h3 id="sqlalchemyuowbase">SqlAlchemyUoWBase<a hidden class="anchor" aria-hidden="true" href="#sqlalchemyuowbase">#</a></h3>
<p>This is the core UoW implementation. It wraps an <code>AsyncSession</code>, tracks events and idempotency keys, and handles nesting rules.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SqlAlchemyUoWBase</span><span class="p">[</span><span class="n">IRepos</span><span class="p">](</span><span class="n">IUnitOfWork</span><span class="p">[</span><span class="n">IRepos</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Unit-of-Work facade with nesting support (reuse vs savepoint).&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">read_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">event_sink</span><span class="p">:</span> <span class="n">EventSink</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">idem_box</span><span class="p">:</span> <span class="n">IdemBox</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_s</span> <span class="o">=</span> <span class="n">session</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_level</span> <span class="o">=</span> <span class="n">level</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span> <span class="o">=</span> <span class="n">read_only</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_tx</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="o">=</span> <span class="n">event_sink</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_idem_box</span> <span class="o">=</span> <span class="n">idem_box</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_repos</span><span class="p">:</span> <span class="n">IRepos</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span></code></pre></div><h3 id="uowmanager">UoWManager<a hidden class="anchor" aria-hidden="true" href="#uowmanager">#</a></h3>
<p>The manager ensures that:</p>
<ul>
<li>Sessions are reused across nested scopes</li>
<li>Events/idempotency are shared at all levels</li>
<li>Commit/rollback/close are coordinated correctly</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UoWManager</span><span class="p">[</span><span class="n">UowBaseT</span><span class="p">,</span> <span class="n">IRepos</span><span class="p">](</span><span class="n">IUoWManager</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Creates UoW scopes over a shared AsyncSession with nesting support.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@asynccontextmanager</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">def</span> <span class="nf">enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">UoWMode</span> <span class="o">=</span> <span class="n">UoWMode</span><span class="o">.</span><span class="n">REUSE</span><span class="p">,</span> <span class="n">read_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">mark_enter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_label</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sf</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_event_sink</span> <span class="o">=</span> <span class="n">EventSink</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_idem_box</span> <span class="o">=</span> <span class="n">IdemBox</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">level</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">nested</span> <span class="o">=</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">mode</span> <span class="ow">is</span> <span class="n">UoWMode</span><span class="o">.</span><span class="n">SAVEPOINT</span>
</span></span><span class="line"><span class="cl">            <span class="n">start_tx</span> <span class="o">=</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">nested</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">uow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uow_cls</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">read_only</span><span class="o">=</span><span class="n">read_only</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">event_sink</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_sink</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">idem_box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_idem_box</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">uow</span><span class="o">.</span><span class="n">set_repos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_repo_factory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">await</span> <span class="n">uow</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">start_tx</span><span class="o">=</span><span class="n">start_tx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">uow</span>
</span></span><span class="line"><span class="cl">                <span class="k">await</span> <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">started_tx</span><span class="o">=</span><span class="n">start_tx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">await</span> <span class="n">uow</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">started_tx</span><span class="o">=</span><span class="n">start_tx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span>
</span></span><span class="line"><span class="cl">            <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">_event_sink</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">_idem_box</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">mark_exit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_label</span><span class="p">)</span>
</span></span></code></pre></div><hr>
<h2 id="-visual-flow">üîÑ Visual Flow<a hidden class="anchor" aria-hidden="true" href="#-visual-flow">#</a></h2>
<h3 id="outermost-transaction-level-1">Outermost Transaction (Level 1)<a hidden class="anchor" aria-hidden="true" href="#outermost-transaction-level-1">#</a></h3>
<pre tabindex="0"><code>BEGIN TRANSACTION
  ... repo operations ...
COMMIT
‚Üí Flush outbox
‚Üí Persist idempotency key
</code></pre><h3 id="nested-reuse-level--1-reuse">Nested Reuse (Level &gt; 1, REUSE)<a hidden class="anchor" aria-hidden="true" href="#nested-reuse-level--1-reuse">#</a></h3>
<pre tabindex="0"><code>(no BEGIN, reuse outer tx)
  ... repo operations ...
(no COMMIT, outer decides)
</code></pre><h3 id="nested-savepoint-level--1-savepoint">Nested Savepoint (Level &gt; 1, SAVEPOINT)<a hidden class="anchor" aria-hidden="true" href="#nested-savepoint-level--1-savepoint">#</a></h3>
<pre tabindex="0"><code>BEGIN NESTED (savepoint)
  ... repo operations ...
RELEASE SAVEPOINT
</code></pre><hr>
<h2 id="-events--idempotency">üì¶ Events + Idempotency<a hidden class="anchor" aria-hidden="true" href="#-events--idempotency">#</a></h2>
<p>Both inner and outer scopes share <strong>the same sinks</strong>:</p>
<ul>
<li><code>EventSink</code> ‚Üí events are buffered and only persisted to the <strong>outbox table</strong> on the <strong>outermost commit</strong></li>
<li><code>IdemBox</code> ‚Üí idempotency key ensures retries don‚Äôt double-commit</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">uow</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s2">&#34;user.created&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">123</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">uow</span><span class="o">.</span><span class="n">set_idempotency_key</span><span class="p">(</span><span class="s2">&#34;req-uuid&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Outer commit persists:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Outbox row</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Idempotency key row</span>
</span></span></code></pre></div><hr>
<h2 id="-quick-comparison">üìä Quick Comparison<a hidden class="anchor" aria-hidden="true" href="#-quick-comparison">#</a></h2>
<table>
  <thead>
      <tr>
          <th>Mode</th>
          <th>Behavior</th>
          <th>Use Case</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>OUTERMOST</strong></td>
          <td>Starts real transaction, commits, flushes events</td>
          <td>Normal service call</td>
      </tr>
      <tr>
          <td><strong>REUSE</strong></td>
          <td>Shares outer transaction, no BEGIN/COMMIT</td>
          <td>Helpers that must be atomic with parent</td>
      </tr>
      <tr>
          <td><strong>SAVEPOINT</strong></td>
          <td>Creates nested savepoint, rollback safe</td>
          <td>Risky operations (e.g., optional steps)</td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="-testing-with-fake-uowmanager">üß™ Testing with Fake UoWManager<a hidden class="anchor" aria-hidden="true" href="#-testing-with-fake-uowmanager">#</a></h2>
<p>One of the biggest benefits of this design is that you can easily <strong>fake the UoW in tests</strong>.</p>
<p>Instead of creating a real SQLAlchemy session, you inject <strong>in-memory repositories</strong>.</p>
<h3 id="fake-manager-example">Fake Manager Example<a hidden class="anchor" aria-hidden="true" href="#fake-manager-example">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FakeConfigRepo</span><span class="p">(</span><span class="n">IConfigRepo</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_configurations_by_group_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="n">group_name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FakeRepos</span><span class="p">(</span><span class="n">IConfigRepos</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">FakeConfigRepo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IConfigRepo</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FakeUoW</span><span class="p">(</span><span class="n">IUnitOfWork</span><span class="p">[</span><span class="n">FakeRepos</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_repos</span> <span class="o">=</span> <span class="n">FakeRepos</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">repos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FakeRepos</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repos</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">started_tx</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">started_tx</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">set_idempotency_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FakeUoWManager</span><span class="p">(</span><span class="n">IUoWManager</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">def</span> <span class="nf">enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">UoWMode</span><span class="o">.</span><span class="n">REUSE</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">uow</span> <span class="o">=</span> <span class="n">FakeUoW</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="n">uow</span>
</span></span></code></pre></div><h3 id="example-test">Example Test<a hidden class="anchor" aria-hidden="true" href="#example-test">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">test_get_configs_returns_items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">mgr</span> <span class="o">=</span> <span class="n">FakeUoWManager</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">with</span> <span class="n">mgr</span><span class="o">.</span><span class="n">enter</span><span class="p">()</span> <span class="k">as</span> <span class="n">uow</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">uow</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConfigItem</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s2">&#34;general&#34;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&#34;x&#34;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&#34;1&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">service</span> <span class="o">=</span> <span class="n">ConfigService</span><span class="p">(</span><span class="n">uow</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_configurations_by_group_name</span><span class="p">(</span><span class="s2">&#34;general&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">is_ok</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>
</span></span></code></pre></div><p>This way:</p>
<ul>
<li>No database required</li>
<li>No transactions opened</li>
<li>Service logic is testable in isolation</li>
</ul>
<hr>
<h2 id="-performance-notes">‚ö° Performance Notes<a hidden class="anchor" aria-hidden="true" href="#-performance-notes">#</a></h2>
<p>One subtle advantage of this design is <strong>control over transaction cost</strong>.</p>
<ul>
<li>
<p><strong><code>REUSE</code> mode</strong> is the fastest:</p>
<ul>
<li>No new transaction, no savepoint, no roundtrips.</li>
<li>Best when nested operations are <em>always safe</em> to run under the parent scope.</li>
</ul>
</li>
<li>
<p><strong><code>SAVEPOINT</code> mode</strong> adds overhead:</p>
<ul>
<li>Each savepoint requires SQL roundtrips (<code>SAVEPOINT</code>, <code>ROLLBACK TO</code>, <code>RELEASE</code>).</li>
<li>Use it when you need to <strong>isolate risky steps</strong> without aborting the entire parent transaction.</li>
</ul>
</li>
</ul>
<p>Example rule of thumb:</p>
<ul>
<li>Use <strong><code>REUSE</code></strong> for 95% of nested calls (normal service-to-service collaboration).</li>
<li>Use <strong><code>SAVEPOINT</code></strong> sparingly (e.g., optional third-party calls, best-effort cleanups).</li>
</ul>
<p>This balance keeps transactions <strong>fast, predictable, and resilient</strong>.</p>
<hr>
<h2 id="-closing-thoughts">üèÅ Closing Thoughts<a hidden class="anchor" aria-hidden="true" href="#-closing-thoughts">#</a></h2>
<p>The <strong>Unit of Work pattern</strong> is not just a persistence abstraction.
It‚Äôs a <strong>contract</strong>:</p>
<ul>
<li><em>Every service runs inside a transaction.</em></li>
<li><em>Events are only published if the transaction commits.</em></li>
<li><em>Duplicate commits are prevented with idempotency.</em></li>
</ul>
<p>With this system, my services are safer, my tests are easier, and my architecture is cleaner.</p>
<p>In asynchronous apps built with SQLAlchemy + FastAPI, a combination of UoW Manager + UoW Base delivers safety, testability, and a clean architecture.</p>
<p>üí¨ Do you prefer implicit context (via contextvars) or explicit scopes like this?
Share your thoughts!</p>
<ul>
<li><a href="https://www.linkedin.com/in/frederico-gago-5849281aa">LinkedIn</a></li>
<li><a href="https://github.com/fredericogago">GitHub</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://fredericogago.github.io/frederico-gago/tags/python/">Python</a></li>
      <li><a href="https://fredericogago.github.io/frederico-gago/tags/sqlalchemy/">SQLAlchemy</a></li>
      <li><a href="https://fredericogago.github.io/frederico-gago/tags/fastapi/">FastAPI</a></li>
      <li><a href="https://fredericogago.github.io/frederico-gago/tags/clean-architecture/">Clean Architecture</a></li>
      <li><a href="https://fredericogago.github.io/frederico-gago/tags/unit-of-work/">Unit of Work</a></li>
      <li><a href="https://fredericogago.github.io/frederico-gago/tags/architecture/">Architecture</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://fredericogago.github.io/frederico-gago/posts/reconciliacao-contribuicoes-erp-portal-python/">
    <span class="title">Next ¬ª</span>
    <br>
    <span>Reconcilia√ß√£o Autom√°tica de Contribui√ß√µes (ERP ‚Üî Portal) com Python</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://fredericogago.github.io/frederico-gago/">Frederico Gago ‚Äì Tech Blog</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
